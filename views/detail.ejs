<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>DreamTalk</title>
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="/css/detail.css" rel="stylesheet" />
  </head>
  <body>
    <!-- Responsive navbar-->
    <%-include('nav.ejs') %>
    <!-- Page content-->
    <div class="container mt-5">
      <div class="row">
        <div class="col-lg-8">
          <!-- Post content-->
          <article>
            <!-- Post header-->
            <header class="mb-4">
              <!-- Post title-->
              <h1 class="fw-bolder mb-1"><%=detailPost.title%></h1>
              <!-- Post meta content-->
              <div class="text-muted fst-italic mb-2">
                작성일: <%=postDate%> 작성자: <%=user.nickname%>
              </div>
            </header>
            <!-- Preview image figure-->
            <figure class="mb-4">
              <img class="img-fluid rounded" src="<%=detailPost.image_url%>" />
            </figure>
            <!-- Post content-->
            <section class="mb-5">
              <p class="fs-5 mb-4"><%= detailPost.content %></p>
            </section>
          </article>
          <!-- Comments section-->
          <section class="mb-5">
            <div class="card bg-light">
              <div class="card-body">
                <!-- Comment form-->
                <form class="mb-4" action="/comment" method="post">
                  <textarea
                    class="form-control"
                    name="content"
                    rows="3"
                    placeholder="소중한 답변을 달아주세요"
                  ></textarea>
                  <!-- 댓글 입력창 -->
                  <input
                    name="parentId"
                    value="<%= detailPost.post_id%>"
                    style="display: none"
                  />
                  <!-- 게시글 번호 전송 -->
                  <button
                    class="postComplete"
                    type="submit"
                    style="border-radius: 6px"
                  >
                    작성 완료
                  </button>
                </form>
                <!-- Comment with nested comments-->
                <%for(let i = 0; i < comments.length; i++){%>
                <div class="d-flex mb-4">
                  <!-- Parent comment-->
                  <div class="ms-3">
                    <%if(commentUser == comments[i].user_id){%>
                    <div class="fw-bold">
                      <%=comments[i].nickname%>님
                      <button
                        class="deleteComment"
                        data-id="<%=comments[i].comment_id%>"
                      >
                        삭제
                      </button>
                      <%=dayjs(comments[i].created_at).format("YYYY-MM-DD")%>
                    </div>
                    <%} else{%>
                    <div class="fw-bold">
                      <%=comments[i].nickname%>님
                      <%=dayjs(comments[i].created_at).format("YYYY-MM-DD")%>
                    </div>
                    <%}%> <%=comments[i].content%>
                    <!-- Child comment 1-->
                  </div>
                </div>
                <%}%>
                <!-- Single comment-->
              </div>
            </div>
          </section>
        </div>
        <!-- Side widgets-->
        <div class="col-lg-4">
          <!-- Categories widget-->
          <div class="card mb-4">
            <div class="card-header">카테고리</div>
            <div class="card-body">
              <div class="row">
                <div class="col-sm-6">
                  <ul class="list-unstyled mb-0">
                    <!-- <li><a href="#!"><%=detailPost.category%></a></li> -->
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Footer-->
    <%-include('footer.ejs') %>

    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
    <script src="js/scripts.js"></script>
    <script>
      let deletes = document.querySelectorAll(".deleteComment");
      for (let i = 0; i < deletes.length; i++) {
        deletes[i].addEventListener("click", function (e) {
          fetch("/deletec?docid=" + e.target.dataset.id, {
            method: "DELETE",
          })
            .then((r) => r.json())
            .then((r) => {
              e.target.parentElement.parentElement.style.display = "none";
            })
            .then(() => {
              alert("삭제 완료");
            });
        });
      }
    </script>
  </body>
</html>
